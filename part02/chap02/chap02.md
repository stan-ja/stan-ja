## 2. ソフトウェア開発としてのモデル構築
Stanで統計モデルの開発を行うということはStanプログラムを書くということを意味し、つまりそれは一種のソフトウェア開発プロセスです。ソフトを開発することは大変です。とても大変です。動くパーツとその組み合わせが非常にたくさんあるため、とても多くのことが間違った方向に向かうことがあります。

コンピュータプログラムを書くこと固有の複雑さによって引き起こされる諸問題を軽減するために、ソフトウェア開発の営みはデザインされています。不幸なことに、多くの方法論は独断的な考えかセコいテクニック、もしくはその両方に話題がそれます。開発者への堅実で実践的なアドバイスで私達がオススメできるものは、(Hunt and Thomas, 1999)と(McConnell, 2004)です。この節では彼らのアドバイスのいくつかをまとめようとしています。

### 2.1. バージョン管理を使う
バージョン管理のソフト（SubversionやGitなど）はコーディングしはじめる前に使えるように用意しておくべきです(注1)。バージョン管理を学ぶことは大きな投資に見えるかもしれません。しかし、一つのコマンドで前に作業していたバージョンに戻ることができたり、今のバージョンと古いバージョンの差分を得ることができますので、その価値はあります。あなたが他の人と作業を共有する必要がある時には、それが紙の上であっても、もっとよいものになります。作業は独立に行われ、自動的にマージされるでしょう。Stan自体がどのように開発されているかについては62章を見てください。

(注1): StanはSubversion (SVN)を使ってはじまりましたが、もっと色々なことができるGitに移行しました。GitはSVNができることは全部できるし、もっと色々なことができます。対価としてはSVNより学習曲線が急なことが挙げられます。個人用、もしくはとても小さいチームでの開発ならSVNでいいです。

### 2.2 再現可能にする
モデルを動かす時にコマンドライン上で（もしくはRやPythonのような言語を対話的なモードで起動して）コマンドを入力するよりは、スクリプトを書いてモデルにデータを入れて、必要な事後の解析を試して欲しいです。スクリプトはシェルスクリプトでもRでもPythonでも書けます(訳注1)。そのスクリプトはどんな言語でもいいですが、必要なものはすべて含んで自己完結しているべきです。設定されているグローバル変数や読み込まれている他のデータに依存するべきではありません。

Stanにおける再現性とそのインターフェースについての完全な情報については22章を見てください。

(訳注1): シェルスクリプトで書く場合はCmdStanを、Rで書く場合はRStanを、Pythonで書く場合はPyStanを使うことになります。

#### スクリプトはよい文書である
もし1行のコードのプロジェクトならやりすぎに見えるかもしれませんが、スクリプトはコードの実行の仕方だけではなく、何が実行されるかについて具体的なドキュメントでもあるべきです。

#### ランダム化と乱数の種の保存
乱数を使ったランダム性は再現性を損なわせますが、MCMC法は概念として乱数を利用します。Stanのサンプラーは乱数を使ったランダムな初期化を行うだけでなく、MCMCのiterationごとにも乱数を使ってランダム化しています（例えば、ハミルトニアン・モンテカルロは各々のiterationでランダムなモーメントを生成します）。

コンピュータは決定論的です。真のランダムネスは存在せず、擬似乱数の生成があるだけです。「種」をもとに乱数の列が生成されます。Stan では（Rのような他の言語でも）時刻や日付に基づいた種を生成する方法を使うことができます。また、種をStanに（もしくはRに）整数として与えることもできます。Stanはあとで結果が再現するように、Stan自体のバージョン番号だけでなく、乱数を生成するのに使った乱数の種を出力することができます(注2)。

(注2): 再現性を保つにはコンパイラを同じにして、ハードウェアを同じにする必要もあります。なぜなら浮動小数点演算はOSやハードウェアの設定やコンパイラをまたいで振る舞いが完全に同じではないからです。


### 2.3. 可読性を高める
他の形式のライティングのように聴衆ありきでプログラムやスクリプトを扱うことで、コードの使われ方について重要な広がりがあります。他人がプログラムやモデルを読みたくなるかもしれないだけでなく、開発者もあとからそれを読みたくなるでしょう。Stanのデザインのモチベーションの一つは次の諸観点からモデルがドキュメントそのものになることでした。変数の使い方（すなわちデータとパラメータの対比）や型（すなわち分散共分散行列と制限のない行列の対比）やサイズの観点です。

可読性の大きな部分は一貫性です。特に名前とレイアウトにおける一貫性です。プログラムだけではなく、そのプログラムが置かれるディレクトリやファイルの名前やレイアウトの一貫性です。

コードの可読性はコメントについてだけではありません（Stanのコメントの推奨や文法については2.8節を見てください）。

誰か他の人に助けを得るためにデバッグやデザインの問題について十分に説明しようとする時に、その問題の解決策が出てくることは驚くべきほどたくさんあります。これはメーリングリスト上でも起こりえます。人to人の時に最もそうなります。あなた自身の問題を誰かに説明する時に解決策を見つけることはソフトウェア開発において非常に多いので、聞いている人は「ラバーダック」と呼ばれています。なぜなら聞いている人は話に合わせてうんうんと相づちを打つだけだからです(注3)。

(注3): 実際のラバーダックではうまくいかないことが研究によって示されています。何らかの理由でラバーダックは実際に説明を理解できなければならないのです。


### 2.4. データを探検する

言うまでもないことですが、やみくもにデータをフィットだけさせようとしないでください。実際に性質を理解しなければならないデータをよく見てください。もしロジスティック回帰をしているなら、それは分離可能ですか？もしマルチレベルモデリングをしているなら、そもそもの結果はレベルごとに変化していますか？もし線形回帰をしているなら、xとyの散布図を書いて線形モデルがあてはまりそうかどうか見てみましょう。


### 2.5. トップダウンでデザインし、ボトムアップでコーディングする

ソフトウェアのプロジェクトはだいたいいつも一つかそれ以上の意図的なユースケースからトップダウンでデザインされます。一方、良いソフトウェアのコーディングは典型的にはボトムアップで行われます。

トップダウンデザインの動機は明白です。ボトムアップ開発の動機は、すでにすっかりテスト済みのコンポーネントを使って開発するほうがはるかに容易だということです。Stanはモジュール対応もテストへの対応も組み込まれていませんが、同じ原理の多くがあてはまります。

Stanの開発者自身がモデルを構築するやり方は、できるだけ単純にスタートし、そこから組み立てていきます。これは最終的に複雑なモデルを想定しているときであっても、また最終的にフィットさせたいモデルの良いアイディアを持っている場合であっても同様です。複数の交互作用、共分散の事前分布、またはその他の複雑な構造の階層的モデルを構築するよりも、単純にスタートしましょう。固定の（そしてややタイトな）事前分布の単純な回帰モデルを構築しましょう。それから交互作用やレベルの追加をおこないます。1度にひとつずつ。正しくなっていることを確認しましょう。それから拡張です。


### 2.6. シミュレートされたデータでフィットさせる

あなたのモデルが計算上正しいことを確認するための最善の方法のひとつは、シミュレートされた（つまり偽りの）データを既知のパラメータで作成し、それからモデルがこのパラメータをデータから推定することができるかどうかを確認することです。もしだめであれば、生のデータで正しい結果を得る希望はほとんど持てないでしょう。

これを行う洒落た方法がいくつかあります。そこでは周辺化された統計量に対するカイ2乗検定を行ったり、区間検定を扱うクックら(2006)の枠組みに従うことができます。


### 2.7. 表示することでデバッグする

Stanにはステップごとのデバッガも単体テストのフレームワークもついていませんが、昔ながらのprintfでのデバッグはサポートしています(注4)。

Stanは1以上の文字列もしくは式を引数として持つprint文をサポートしています。Stanは命令型の言語なので、変数はプログラムの実行中に異なる場所で異なる値を持つことができます。print文はStanのようなステップごとのデバッガを持たない言語には非常に価値があります。

例えば、変数yとzの値を表示するときは以下のような文を使います。 
```
print("y=", y, " z=", z);
```
このprint文は文字列`"y="`に続いて変数yの値、文字列`" z="`(頭にスペースをつけて)に続いて変数zの値を表示します。

それぞれのprint文の最後には改行がつきます。改行のための具体的なアスキー文字はプラットフォーム依存です。

任意の式表現を使うことができます。例えば、
```
print("1+1=", 1+1);
```
という文は`"1+1=2"`に続けて改行を表示します。

print文は他の命令を使うことができる場所ならどこでも使うことができますが、何回実行されるかは記述されているブロックがどのくらいの回数評価されるかに依存します。print文の文法と評価について詳しくはセクション26.8を参照してください。

(注4) 「f」がついているのはタイプミスではありません。これはC言語で書式付き表示をするときに使われるprintf関数の名前にちなんだ歴史的な産物です。

 
### 2.8. コメント

#### コードは嘘をつかない

機械はドキュメントに書かれたことではなくコードに書かれたことを実行します。ドキュメントは一方、必ずしもコードと一致しません。ドキュメントがきちんとメンテナンスされていない場合、コードの進化にともなってコードのドキュメントは容易に腐ってしまいます。

したがって、読めないコードのドキュメントを書くのに対して、読めるコードを書くほうが常に好ましいです。ドキュメントを書くときにはいつも、コードをそんな風にかく方法がないか自問して、ドキュメントが不必要になるようにしましょう。

#### Stanのコメントスタイル

StanはC++スタイルのコメントをサポートしています。詳しくはセクション28.1をごらんください。お勧めのスタイルはコード内の短いコメントや1行以上をコメントアウトするときには行コメントにすることです。ブロックコメントは長いドキュメンテーションコメント用にとっておきます。このしきたりの理由は、ブロックコメントはブロックコメントの中に作ることができないからです。

#### コメントすべきでないこと

コードにコメントをつける際、使用中のプログラミング言語の基本を理解している他のプログラマのためにコメントを書いていると想定するのが通常は安全です。別の言葉で言えば、明白なことはコメントしてはいけません。例えば、以下のような、コードに何の情報も付加しないコメントを書く必要はありません。
```
y ~ normal(0,1);  // yは標準正規分布に従う
```
以下の例のような手動での変数変換に対するヤコビアンの調整であればコメントする価値があるかもしれません。 
```
exp(y) ~ normal(0,1);
// 変数変換に対するヤコビアンの調整: y = log | d/dy exp(y) |
increment_log_prob(y);
```
将来このコードを読む人に共感し、その人達が統計やStanについて何を知らないか（または覚えていないか）を決めてコメントを書くのは一種の芸術です。

#### コメントすべきこと

`N`や`mu`、`sigma`といった一般的な変数名をつけているときには変数宣言にコメントをつけることが助けになるでしょう。例えば、項目反応モデルにおけるいくつかのデータ変数宣言は以下のように有用なコメントをつけるとよいでしょう。
```
int<lower=1> N;  // 観測数
int<lower=1> I;  // 生徒数
int<lower=1> J;  // テストの問題数
```
別の方法は、コメントが不要な長い変数名にすることです。
```
int<lower=1> n_obs;
int<lower=1> n_students;
int<lower=1> n_questions;
```
どちらのスタイルも合理的で、どちらを採用するかは主として好みの問題です（統計的な慣習を持つコードの読者を混乱させないように、時にモデル独自の命名の慣習に従う必要があるというのが主な理由です）。

一部のコード作者は冒頭に大きなブロックコメントを置いてモデルの目的、誰が書いたか、著作権とライセンスの情報などなどを説明することを好みます。以下の複数行コメントは大きなコメントブロックの従来の書き方の例です。
```
/*
* Item-Response Theory PL3 Model
 * -----------------------------------------------------
 * Copyright: Joe Schmoe  <joe@schmoe.com>
 * Date:  19 September 2012
 * License: GPLv3
 */
data {
  // ...
```
アスタリスクで始まるコメントの書き方は読者がコメントの範囲を理解するのを助けます。一方コメントに日付やその他の変わりやすい情報を含めることの問題点は、その情報が、簡単にコードの実情と同期しなくなってしまうことです。誤解を招いたり間違っているコメントは、全くコメントがないよりも悪いのです！
