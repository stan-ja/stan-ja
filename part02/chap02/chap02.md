## 2. ソフトウェア開発としてのモデル構築
Stanで統計モデルの開発を行うということはStanプログラムを書くということを意味し、つまりそれは一種のソフトウェア開発プロセスです。ソフトを開発することは大変です。とても大変です。動くパーツとその組み合わせが非常にたくさんあるため、とても多くのことが間違った方向に向かうことがあります。

コンピュータプログラムを書くこと固有の複雑さによって引き起こされる諸問題を軽減するために、ソフトウェア開発の営みはデザインされています。不幸なことに、多くの方法論は独断的な考えかセコいテクニック、もしくはその両方に話題がそれます。開発者への堅実で実践的なアドバイスで私達がオススメできるものは、(Hunt and Thomas, 1999)と(McConnell, 2004)です。この節では彼らのアドバイスのいくつかをまとめようとしています。

### 2.1. バージョン管理を使う
バージョン管理のソフト（SubversionやGitなど）はコーディングしはじめる前に使えるように用意しておくべきです(注1)。バージョン管理を学ぶことは大きな投資に見えるかもしれません。しかし、一つのコマンドで前に作業していたバージョンに戻ることができたり、今のバージョンと古いバージョンの差分を得ることができますので、その価値はあります。あなたが他の人と作業を共有する必要がある時には、それが紙の上であっても、もっとよいものになります。作業は独立に行われ、自動的にマージされるでしょう。Stan自体がどのように開発されているかについては62章を見てください。

(注1): StanはSubversion (SVN)を使ってはじまりましたが、もっと色々なことができるGitに移行しました。GitはSVNができることは全部できるし、もっと色々なことができます。対価としてはSVNより学習曲線が急なことが挙げられます。個人用、もしくはとても小さいチームでの開発ならSVNでいいです。

### 2.2 再現可能にする
モデルを動かす時にコマンドライン上で（もしくはRやPythonのような言語を対話的なモードで起動して）コマンドを入力するよりは、スクリプトを書いてモデルにデータを入れて、必要な事後の解析を試して欲しいです。スクリプトはシェルスクリプトでもRでもPythonでも書けます(訳注1)。そのスクリプトはどんな言語でもいいですが、必要なものはすべて含んで自己完結しているべきです。設定されているグローバル変数や読み込まれている他のデータに依存するべきではありません。

Stanにおける再現性とそのインターフェースについての完全な情報については22章を見てください。

(訳注1): シェルスクリプトで書く場合はCmdStanを、Rで書く場合はRStanを、Pythonで書く場合はPyStanを使うことになります。

#### スクリプトはよい文書である
もし1行のコードのプロジェクトならやりすぎに見えるかもしれませんが、スクリプトはコードの実行の仕方だけではなく、何が実行されるかについて具体的なドキュメントでもあるべきです。

#### ランダム化と乱数の種の保存
乱数を使ったランダム性は再現性を損なわせますが、MCMC法は概念として乱数を利用します。Stanのサンプラーは乱数を使ったランダムな初期化を行うだけでなく、MCMCのiterationごとにも乱数を使ってランダム化しています（例えば、ハミルトニアン・モンテカルロは各々のiterationでランダムなモーメントを生成します）。

コンピュータは決定論的です。真のランダムネスは存在せず、擬似乱数の生成があるだけです。「種」をもとに乱数の列が生成されます。Stan では（Rのような他の言語でも）時刻や日付に基づいた種を生成する方法を使うことができます。また、種をStanに（もしくはRに）整数として与えることもできます。Stanはあとで結果が再現するように、Stan自体のバージョン番号だけでなく、乱数を生成するのに使った乱数の種を出力することができます(注2)。

(注2): 再現性を保つにはコンパイラを同じにして、ハードウェアを同じにする必要もあります。なぜなら浮動小数点演算はOSやハードウェアの設定やコンパイラをまたいで振る舞いが完全に同じではないからです。


### 2.3. 可読性を高める
他の形式のライティングのように聴衆ありきでプログラムやスクリプトを扱うことで、コードの使われ方について重要な広がりがあります。他人がプログラムやモデルを読みたくなるかもしれないだけでなく、開発者もあとからそれを読みたくなるでしょう。Stanのデザインのモチベーションの一つは次の諸観点からモデルがドキュメントそのものになることでした。変数の使い方（すなわちデータとパラメータの対比）や型（すなわち分散共分散行列と制限のない行列の対比）やサイズの観点です。

可読性の大きな部分は一貫性です。特に名前とレイアウトにおける一貫性です。プログラムだけではなく、そのプログラムが置かれるディレクトリやファイルの名前やレイアウトの一貫性です。

コードの可読性はコメントについてだけではありません（Stanのコメントの推奨や文法については2.8節を見てください）。

誰か他の人に助けを得るためにデバッグやデザインの問題について十分に説明しようとする時に、その問題の解決策が出てくることは驚くべきほどたくさんあります。これはメーリングリスト上でも起こりえます。人to人の時に最もそうなります。あなた自身の問題を誰かに説明する時に解決策を見つけることはソフトウェア開発において非常に多いので、聞いている人は「ラバーダック」と呼ばれています。なぜなら聞いている人は話に合わせてうんうんと相づちを打つだけだからです(注3)。

(注3): 実際のラバーダックではうまくいかないことが研究によって示されています。何らかの理由でラバーダックは実際に説明を理解できなければならないのです。
